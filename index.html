<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线跟打器</title>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', 'Consolas', monospace;
            background-color: #f8f9fa;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            color: #333;
        }

        /* 顶部导航栏 */
        .header {
            background: #ffffff;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid #eaeaea;
        }

        .header h1 {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .mode-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }

        .mode-switch label {
            font-size: 14px;
            color: #666;
        }

        .btn {
            padding: 8px 16px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
            white-space: nowrap;
        }

        .btn:hover {
            background: #3a56e4;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
        }

        .btn-secondary:hover {
            background: #5a6268;
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }

        .btn-warning:hover {
            background: #e0a800;
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        /* 主要内容区域 */
        .main-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        /* 左侧练习区域 */
        .practice-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 文章显示区 */
        .article-display {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 240px;
            overflow-y: auto;
            font-size: 18px;
            line-height: 1.8;
            letter-spacing: 0.5px;
            border: 1px solid #eaeaea;
        }

        .article-content {
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* 字符样式 */
        .char {
            position: relative;
            display: inline-block;
            min-width: 0.5em;
            transition: background-color 0.1s ease;
        }

        .char.correct {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-radius: 2px;
        }

        .char.incorrect {
            background-color: #ffebee;
            color: #c62828;
            border-radius: 2px;
            text-decoration: underline;
        }

        /* 输入区 */
        .input-area {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #eaeaea;
        }

        .typing-input {
            width: 100%;
            height: 240px;
            padding: 15px;
            font-size: 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: none;
            line-height: 1.8;
            letter-spacing: 0.5px;
            transition: border-color 0.2s ease;
        }

        .typing-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* 右侧统计面板 */
        .stats-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #eaeaea;
        }

        .stat-card h3 {
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-unit {
            font-size: 12px;
            color: #666;
            margin-left: 5px;
        }

        /* 剩余时间卡片特殊样式 */
        .stat-card.time-limit-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.time-limit-card h3 {
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-card.time-limit-card .stat-value {
            color: white;
        }

        .stat-card.time-limit-card .stat-unit {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 结果显示 */
        .result-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 500px;
            width: 90%;
            border: 1px solid #eaeaea;
        }

        .result-modal.show {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 999;
        }

        .modal-overlay.show {
            display: block;
        }

        /* 载文模态框 */
        .load-text-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 600px;
            max-width: 90%;
            border: 1px solid #eaeaea;
        }

        .load-text-modal.show {
            display: block;
        }

        .load-text-modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 500;
        }

        .load-text-modal textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            resize: vertical;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.5;
        }

        .load-text-modal textarea:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .load-text-modal .btn-group {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 时间限制模态框 */
        .time-limit-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 350px;
            max-width: 90%;
            border: 1px solid #eaeaea;
        }

        .time-limit-modal.show {
            display: block;
        }

        .time-limit-modal h3 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-weight: 500;
            text-align: center;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .time-input {
            width: 100px;
            padding: 10px;
            font-size: 20px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: border-color 0.2s ease;
        }

        .time-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .time-unit-selector {
            display: flex;
            gap: 10px;
        }

        .time-unit-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-unit-btn.active {
            background: #4361ee;
            color: white;
            border-color: #4361ee;
        }

        .time-limit-modal .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        /* 移动端头部统计栏 */
        .mobile-stats-bar {
            display: none;
            background: white;
            padding: 10px 15px;
            border-bottom: 1px solid #eaeaea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .mobile-stats-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-stat-item {
            text-align: center;
        }

        .mobile-stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .mobile-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                overflow: hidden;
            }

            .header {
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header-buttons {
                gap: 8px;
            }

            .mode-switch {
                display: none;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .mobile-stats-bar {
                display: block;
            }

            .main-container {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
                height: calc(100vh - 120px);
                overflow-y: auto;
            }

            .stats-panel {
                display: none;
            }

            .article-display {
                height: 200px;
                padding: 15px;
                font-size: 16px;
            }

            .typing-input {
                height: 150px;
                font-size: 16px;
                padding: 10px;
            }

            .input-area {
                padding: 15px;
            }

            .result-modal {
                padding: 25px;
            }

            .time-limit-modal {
                width: 300px;
                padding: 20px;
            }

            .time-input {
                width: 80px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }

            .btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .article-display {
                height: 180px;
                font-size: 14px;
            }

            .typing-input {
                height: 120px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- 头部导航 -->
    <div class="header">
        <h1>在线跟打器</h1>
        <div class="header-buttons">
            <div class="mode-switch">
                <label>输入模式：</label>
                <select id="inputMode" class="btn btn-secondary" onchange="handleModeChange()">
                    <option value="english">英文模式</option>
                    <option value="chinese">中文模式</option>
                </select>
            </div>
            <select id="articleSelect" class="btn btn-secondary">
                <option value="0">文章1</option>
                <option value="1">文章2</option>
                <option value="2">文章3</option>
            </select>
            <button class="btn" onclick="showLoadTextModal()">载文</button>
            <button class="btn btn-warning" onclick="showTimeLimitModal()">自定义时间</button>
            <button class="btn btn-secondary" onclick="resetPractice()">重新开始</button>
        </div>
    </div>

    <!-- 移动端统计栏 -->
    <div class="mobile-stats-bar">
        <div class="mobile-stats-container">
            <div class="mobile-stat-item">
                <div class="mobile-stat-label">速度</div>
                <div class="mobile-stat-value"><span id="mobileSpeed">0</span> 字/分</div>
            </div>
            <div class="mobile-stat-item">
                <div class="mobile-stat-label">准确率</div>
                <div class="mobile-stat-value"><span id="mobileAccuracy">100</span>%</div>
            </div>
            <div class="mobile-stat-item">
                <div class="mobile-stat-label">用时</div>
                <div class="mobile-stat-value" id="mobileTimer">00:00</div>
            </div>
            <div class="mobile-stat-item" id="mobileTimeLimitDisplay" style="display: none;">
                <div class="mobile-stat-label">剩余</div>
                <div class="mobile-stat-value" id="mobileTimeRemaining">--:--</div>
            </div>
        </div>
    </div>

    <!-- 主要内容区 -->
    <div class="main-container">
        <!-- 左侧练习区 -->
        <div class="practice-area">
            <!-- 文章显示区 -->
            <div class="article-display">
                <div class="article-content" id="articleContent"></div>
            </div>
            
            <!-- 输入区 -->
            <div class="input-area">
                <textarea class="typing-input" id="typingInput" 
                    placeholder="点击这里开始输入..."
                    onfocus="handleInputFocus()"
                    onblur="handleInputBlur()"></textarea>
            </div>
        </div>

        <!-- 右侧统计面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <h3>速度</h3>
                <div>
                    <span class="stat-value" id="speed">0</span>
                    <span class="stat-unit">字/分</span>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>准确率</h3>
                <div>
                    <span class="stat-value" id="accuracy">100</span>
                    <span class="stat-unit">%</span>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>用时</h3>
                <div>
                    <span class="stat-value" id="timer">00:00</span>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>进度</h3>
                <div>
                    <span id="correctChars">0</span> / 
                    <span id="totalChars">0</span> 字
                </div>
            </div>

            <!-- 剩余时间卡片 -->
            <div class="stat-card time-limit-card" id="timeLimitCard" style="display: none;">
                <h3>剩余时间</h3>
                <div>
                    <span class="stat-value" id="timeRemaining">--:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果模态框 -->
    <div class="modal-overlay" id="modalOverlay" onclick="hideAllModals()"></div>
    <div class="result-modal" id="resultModal">
        <h2>练习完成！</h2>
        <div style="margin-top: 20px;">
            <p>速度：<strong id="finalSpeed">0</strong> 字/分</p>
            <p>准确率：<strong id="finalAccuracy">0</strong>%</p>
            <p>正确字数：<strong id="finalCorrect">0</strong> 字</p>
            <p>错误字数：<strong id="finalErrors">0</strong> 字</p>
            <p>总用时：<strong id="finalTime">00:00</strong></p>
        </div>
        <button class="btn" style="margin-top: 20px; width: 100%;" onclick="hideResultModal()">关闭</button>
    </div>

    <!-- 载文模态框 -->
    <div class="load-text-modal" id="loadTextModal">
        <h3>载入文章</h3>
        <textarea id="customTextInput" placeholder="请输入或粘贴文章内容..."></textarea>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="hideLoadTextModal()">取消</button>
            <button class="btn" onclick="loadCustomText()">确定</button>
        </div>
    </div>

    <!-- 时间限制模态框 -->
    <div class="time-limit-modal" id="timeLimitModal">
        <h3>设置限定时间</h3>
        <div class="time-input-group">
            <input type="number" class="time-input" id="timeValue" min="1" max="999" value="60">
            <div class="time-unit-selector">
                <button class="time-unit-btn active" data-unit="seconds" onclick="selectTimeUnit(this)">秒</button>
                <button class="time-unit-btn" data-unit="minutes" onclick="selectTimeUnit(this)">分</button>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="hideTimeLimitModal()">取消</button>
            <button class="btn btn-secondary" onclick="clearTimeLimit()">清除限时</button>
            <button class="btn" onclick="setTimeLimit()">确定</button>
        </div>
    </div>

    <script>
        // ========== 全局变量定义 ==========
        const chineseArticles = [
            `编程是一门艺术，它不仅仅是敲击键盘写代码那么简单。一个优秀的程序员需要具备逻辑思维、创造力和解决问题的能力。在这个快速发展的时代，技术日新月异，我们必须保持学习的热情，不断提升自己的技能。代码质量的好坏直接影响到软件的稳定性和可维护性。因此，我们应该养成良好的编程习惯，写出简洁、高效、易读的代码。同时，团队合作也是软件开发中不可或缺的一部分。通过代码审查、知识分享和技术讨论，我们可以共同进步，创造出更好的产品。`,
            `春天来了，万物复苏。公园里的花朵竞相绽放，红的、黄的、粉的，五彩缤纷，美不胜收。微风轻拂，带来阵阵花香，让人心旷神怡。孩子们在草地上奔跑嬉戏，欢声笑语回荡在空中。老人们坐在长椅上晒太阳，享受着这温暖的时光。小鸟在枝头欢快地歌唱，仿佛在庆祝这美好的季节。湖水波光粼粼，倒映着蓝天白云，构成一幅动人的画卷。这就是春天，充满生机与希望的季节。`,
            `科技改变生活，创新引领未来。从智能手机到人工智能，从互联网到物联网，技术的发展深刻地改变着我们的生活方式。在线教育让知识传播更加便捷，远程医疗让看病就医更加方便，电子商务让购物更加轻松。5G技术的普及将带来更快的网速和更低的延迟，为自动驾驶、虚拟现实等新技术的应用奠定基础。区块链技术保障了数据的安全性和透明性，量子计算将突破传统计算的极限。让我们拥抱科技，共创美好未来。`
        ];

        const englishArticles = [
            `Technology has transformed the way we live, work, and communicate. From smartphones to artificial intelligence, innovations continue to reshape our daily experiences. The internet has connected people across the globe, breaking down geographical barriers and enabling instant communication. Social media platforms have revolutionized how we share information and maintain relationships. As we move forward, emerging technologies like virtual reality, blockchain, and quantum computing promise to bring even more dramatic changes. However, with these advancements come new challenges regarding privacy, security, and ethical considerations. It is crucial that we embrace innovation while remaining mindful of its impact on society and individuals.`,
            `Learning a new language opens doors to countless opportunities and experiences. It enhances cognitive abilities, improves memory, and increases cultural awareness. When we study a foreign language, we gain insights into different ways of thinking and expressing ideas. This process challenges our brains and helps develop problem-solving skills. Moreover, being multilingual in today's globalized world provides significant career advantages. It enables better communication with international colleagues and clients, making us more valuable in the job market. The journey of language learning may be challenging, but the rewards are immeasurable. Every new word learned is a step toward broader horizons and deeper understanding.`,
            `The importance of environmental conservation cannot be overstated in our modern world. Climate change poses significant threats to ecosystems, wildlife, and human communities worldwide. We must take immediate action to reduce carbon emissions, protect natural habitats, and promote sustainable practices. Simple daily choices, such as recycling, using renewable energy, and reducing water consumption, can make a meaningful difference. Governments, businesses, and individuals must work together to create lasting solutions. Education plays a vital role in raising awareness and inspiring action. By teaching future generations about environmental responsibility, we can ensure a healthier planet for years to come. The time for change is now.`
        ];

        let articles = englishArticles;
        let currentArticle = '';
        let processedArticle = '';
        let currentIndex = 0;
        let startTime = null;
        let timerInterval = null;
        let isPaused = true;
        let correctCount = 0;
        let errorCount = 0;
        let displayOffset = 0;
        let inputMode = 'english';
        let isComposing = false;
        
        // 时间限制相关变量
        let timeLimit = null; // 限制时间（秒）
        let timeElapsed = 0; // 已用时间（秒）
        let timeLimitInterval = null; // 倒计时定时器
        
        const LINES_PER_PAGE = 7;
        const CHARS_PER_LINE = 35;

        // ========== 初始化函数 ==========
        function init() {
            loadArticle(0);
            
            const input = document.getElementById('typingInput');
            input.addEventListener('input', handleInput);
            
            input.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            input.addEventListener('compositionend', () => {
                isComposing = false;
                handleInput({ target: input });
            });
            
            document.getElementById('articleSelect').addEventListener('change', (e) => {
                loadArticle(parseInt(e.target.value));
            });
            
            document.addEventListener('keydown', async (e) => {
                if (e.altKey && e.key === 'e') {
                    e.preventDefault();
                    await pasteFromClipboard();
                }
            });
        }

        // ========== 时间限制功能 ==========
        function showTimeLimitModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('timeLimitModal').classList.add('show');
        }

        function hideTimeLimitModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('timeLimitModal').classList.remove('show');
        }

        function selectTimeUnit(btn) {
            document.querySelectorAll('.time-unit-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setTimeLimit() {
            const value = parseInt(document.getElementById('timeValue').value);
            const unit = document.querySelector('.time-unit-btn.active').dataset.unit;
            
            if (value && value > 0) {
                timeLimit = unit === 'minutes' ? value * 60 : value;
                
                // 显示剩余时间卡片
                document.getElementById('timeLimitCard').style.display = 'block';
                document.getElementById('mobileTimeLimitDisplay').style.display = 'block';
                
                updateTimeRemaining();
                hideTimeLimitModal();
                
                // 重置练习
                resetPractice();
            }
        }

        function clearTimeLimit() {
            timeLimit = null;
            timeElapsed = 0;
            
            // 隐藏剩余时间卡片
            document.getElementById('timeLimitCard').style.display = 'none';
            document.getElementById('mobileTimeLimitDisplay').style.display = 'none';
            
            if (timeLimitInterval) {
                clearInterval(timeLimitInterval);
                timeLimitInterval = null;
            }
            
            hideTimeLimitModal();
        }

        function updateTimeRemaining() {
            if (timeLimit) {
                const remaining = Math.max(0, timeLimit - timeElapsed);
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timeRemaining').textContent = timeStr;
                document.getElementById('mobileTimeRemaining').textContent = timeStr;
                
                // 时间到了
                if (remaining === 0) {
                    endPractice(true);
                }
            }
        }

        // ========== 模式切换处理 ==========
        function handleModeChange() {
            inputMode = document.getElementById('inputMode').value;
            
            if (inputMode === 'english') {
                articles = englishArticles;
            } else {
                articles = chineseArticles;
            }
            
            updateArticleSelectOptions();
            loadArticle(0);
        }

        function updateArticleSelectOptions() {
            const articleSelect = document.getElementById('articleSelect');
            const options = articleSelect.options;
            
            if (inputMode === 'english') {
                options[0].text = '文章1';
                options[1].text = '文章2';
                options[2].text = '文章3';
            } else {
                options[0].text = '文章1';
                options[1].text = '文章2';
                options[2].text = '文章3';
            }
        }

        // ========== 文章处理函数 ==========
        function processArticleForMode(text) {
            if (inputMode === 'chinese') {
                return text.replace(/\s+/g, '');
            } else {
                return text.replace(/([,.])\s+/g, '$1');
            }
        }

        function filterInputForMode(input) {
            if (inputMode === 'chinese') {
                return input.replace(/[a-zA-Z]/g, '');
            }
            return input;
        }

        // ========== 文章加载与显示 ==========
        function loadArticle(index) {
            currentArticle = articles[index];
            processedArticle = processArticleForMode(currentArticle);
            resetPractice();
        }

        function loadCustomArticle(text) {
            currentArticle = text.trim();
            processedArticle = processArticleForMode(currentArticle);
            resetPractice();
        }

        function renderArticle() {
            const container = document.getElementById('articleContent');
            container.innerHTML = '';
            
            const articleToRender = processedArticle;
            const startIndex = displayOffset;
            const endIndex = Math.min(startIndex + LINES_PER_PAGE * CHARS_PER_LINE, articleToRender.length);
            
            const filteredInput = filterInputForMode(document.getElementById('typingInput').value);
            
            for (let i = 0; i < articleToRender.length; i++) {
                const span = document.createElement('span');
                span.className = 'char';
                span.textContent = articleToRender[i];
                
                if (i < filteredInput.length) {
                    const inputChar = filteredInput[i];
                    if (inputChar === articleToRender[i]) {
                        span.classList.add('correct');
                    } else {
                        span.classList.add('incorrect');
                    }
                }
                
                if (i >= startIndex && i < endIndex) {
                    container.appendChild(span);
                }
            }
            
            document.getElementById('totalChars').textContent = articleToRender.length;
        }

        // ========== 输入处理 ==========
        function handleInput(e) {
            if (isComposing && inputMode === 'chinese') {
                return;
            }
            
            const rawInput = e.target.value;
            const filteredInput = filterInputForMode(rawInput);
            const inputLength = filteredInput.length;
            
            if (!startTime && inputLength > 0) {
                startTimer();
            }
            
            currentIndex = inputLength;
            
            const currentPage = Math.floor(currentIndex / (LINES_PER_PAGE * CHARS_PER_LINE));
            const newOffset = currentPage * LINES_PER_PAGE * CHARS_PER_LINE;
            if (newOffset !== displayOffset) {
                displayOffset = newOffset;
            }
            
            correctCount = 0;
            errorCount = 0;
            
            const articleToCompare = processedArticle;
            for (let i = 0; i < inputLength && i < articleToCompare.length; i++) {
                if (filteredInput[i] === articleToCompare[i]) {
                    correctCount++;
                } else {
                    errorCount++;
                }
            }
            
            renderArticle();
            updateStats();
            
            if (inputLength >= articleToCompare.length) {
                endPractice(false);
            }
        }

        function handleInputFocus() {
            if (timerInterval && isPaused) {
                isPaused = false;
            }
        }

        function handleInputBlur() {
            if (timerInterval && !isPaused) {
                isPaused = true;
            }
        }

        // ========== 计时器功能 ==========
        function startTimer() {
            startTime = Date.now();
            isPaused = false;
            timeElapsed = 0;
            
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    updateTimer();
                    updateStats();
                    
                    // 更新限时倒计时
                    if (timeLimit) {
                        timeElapsed = Math.floor((Date.now() - startTime) / 1000);
                        updateTimeRemaining();
                    }
                }
            }, 100);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timer').textContent = timeStr;
            document.getElementById('mobileTimer').textContent = timeStr;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (timeLimitInterval) {
                clearInterval(timeLimitInterval);
                timeLimitInterval = null;
            }
        }

        // ========== 统计更新 ==========
        function updateStats() {
            document.getElementById('correctChars').textContent = correctCount;
            
            if (startTime && currentIndex > 0) {
                const elapsedMinutes = (Date.now() - startTime) / 60000;
                const cpm = Math.round(currentIndex / elapsedMinutes);
                document.getElementById('speed').textContent = cpm;
                document.getElementById('mobileSpeed').textContent = cpm;
            }
            
            if (currentIndex > 0) {
                const accuracy = Math.round((correctCount / currentIndex) * 100);
                document.getElementById('accuracy').textContent = accuracy;
                document.getElementById('mobileAccuracy').textContent = accuracy;
            }
        }

        // ========== 练习控制 ==========
        function resetPractice() {
            stopTimer();
            
            currentIndex = 0;
            startTime = null;
            isPaused = true;
            correctCount = 0;
            errorCount = 0;
            displayOffset = 0;
            timeElapsed = 0;
            
            document.getElementById('typingInput').value = '';
            document.getElementById('typingInput').focus();
            
            document.getElementById('speed').textContent = '0';
            document.getElementById('mobileSpeed').textContent = '0';
            document.getElementById('accuracy').textContent = '100';
            document.getElementById('mobileAccuracy').textContent = '100';
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('mobileTimer').textContent = '00:00';
            document.getElementById('correctChars').textContent = '0';
            
            if (timeLimit) {
                updateTimeRemaining();
            }
            
            processedArticle = processArticleForMode(currentArticle);
            renderArticle();
        }

        function endPractice(isTimeUp) {
            stopTimer();
            
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            const elapsedMinutes = elapsedSeconds / 60;
            const finalCPM = Math.round(currentIndex / elapsedMinutes);
            const finalAccuracy = currentIndex > 0 ? Math.round((correctCount / currentIndex) * 100) : 100;
            
            document.getElementById('finalSpeed').textContent = finalCPM;
            document.getElementById('finalAccuracy').textContent = finalAccuracy;
            document.getElementById('finalCorrect').textContent = correctCount;
            document.getElementById('finalErrors').textContent = errorCount;
            document.getElementById('finalTime').textContent = document.getElementById('timer').textContent;
            
            if (isTimeUp) {
                document.querySelector('#resultModal h2').textContent = '时间到！';
            } else {
                document.querySelector('#resultModal h2').textContent = '练习完成！';
            }
            
            showResultModal();
        }

        // ========== 模态框控制 ==========
        function showResultModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('resultModal').classList.add('show');
        }

        function hideResultModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('resultModal').classList.remove('show');
        }

        function showLoadTextModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('loadTextModal').classList.add('show');
            document.getElementById('customTextInput').focus();
        }

        function hideLoadTextModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('loadTextModal').classList.remove('show');
            document.getElementById('customTextInput').value = '';
        }

        function hideAllModals() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('resultModal').classList.remove('show');
            document.getElementById('loadTextModal').classList.remove('show');
            document.getElementById('timeLimitModal').classList.remove('show');
        }

        // ========== 载文功能 ==========
        function loadCustomText() {
            const text = document.getElementById('customTextInput').value.trim();
            if (text) {
                loadCustomArticle(text);
                hideLoadTextModal();
            }
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text.trim()) {
                    loadCustomArticle(text);
                }
            } catch (err) {
                showLoadTextModal();
                alert('无法自动读取剪贴板，请手动粘贴文本');
            }
        }

        // ========== 页面加载完成后初始化 ==========
        window.onload = init;
    </script>
</body>
</html>
